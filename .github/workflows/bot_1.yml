name: Minecraft Java Bot No 2 by ks_warrior

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: ks-mc-bot
  cancel-in-progress: true

jobs:
  run-mc-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 305

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create Bot File with DNS Resolve & Safe Reconnect
        shell: bash
        run: |
          cat > ks-bot.js <<'EOF'
           const mineflayer = require('mineflayer');
           const dns = require('dns');

           const SERVER_HOST = '185.107.193.163';
           const SERVER_PORT = 34150;
           const BOT_USERNAME = process.argv[2] || 'Player5';
           const RECONNECT_DELAY = 60000; // 1 min for Aternos safety
           const AFK_INTERVAL = 20000; // 20 seconds

           let bot;
           let shouldStop = false;
           let afkInterval;

           function clearBotIntervals() {
             if (afkInterval) clearInterval(afkInterval);
             afkInterval = null;
           }

           function startBot(hostIP) {
             console.log(`🚀 Starting bot "${BOT_USERNAME}" -> ${hostIP}:${SERVER_PORT}`);
             bot = mineflayer.createBot({
               host: hostIP,
               port: SERVER_PORT,
               username: BOT_USERNAME
             });

             bot.on('login', () => console.log(`✅ Logged in as ${BOT_USERNAME}`));

             bot.on('spawn', () => {
               console.log('🏞 Spawned in world');
               clearBotIntervals();
               afkInterval = setInterval(() => {
                 if (!bot || !bot.entity) return;
                 const yaw = Math.random() * Math.PI * 2;
                 bot.look(yaw, 0, false);
                 const actions = ['forward','back','left','right'];
                 const action = actions[Math.floor(Math.random()*actions.length)];
                 bot.setControlState(action, true);
                 if (Math.random() > 0.7) {
                   bot.setControlState('jump', true);
                   setTimeout(()=>bot.setControlState('jump', false),500);
                 }
                 setTimeout(()=>bot.setControlState(action,false),1000);
               }, AFK_INTERVAL);
             });

             bot.on('end', () => {
               console.log('❌ Bot disconnected');
               clearBotIntervals();
               if (!shouldStop) {
                 console.log(`🔄 Reconnecting in ${RECONNECT_DELAY/1000}s...`);
                 setTimeout(resolveHostAndStart, RECONNECT_DELAY);
               }
             });

             bot.on('kicked', (reason) => console.log('⚠️ Kicked:', reason));
             bot.on('error', (err) => console.log('💥 Error:', err.message));
           }

           function resolveHostAndStart() {
             dns.lookup(SERVER_HOST, (err, address) => {
               if (err) {
                 console.log('🌐 DNS error:', err.message);
                 return setTimeout(resolveHostAndStart, RECONNECT_DELAY);
               }
               console.log(`🔍 Resolved ${SERVER_HOST} -> ${address}`);
               startBot(address);
             });
           }

           // Console commands
           process.stdin.on('data', (data) => {
             const cmd = data.toString().trim();
             if (cmd === 'quit' || cmd === 'stop') {
               console.log('🛑 Stopping bot...');
               shouldStop = true;
               bot.end();
               process.exit(0);
             } else if (cmd && bot) {
               bot.chat(cmd);
             }
           });

           resolveHostAndStart();
          EOF

      - name: Install dependencies
        shell: bash
        run: |
          npm init -y
          npm install mineflayer mineflayer-pathfinder

      - name: Start Minecraft Bot (300m runtime)
        shell: bash
        run: |
          timeout 555 node ks-bot.js || true

      - name: Restart Workflow (every 5h)
        uses: benc-uk/workflow-dispatch@v1
        if: ${{ always() }}
        with:
          workflow: Minecraft Java Bot No 2 by ks_warrior
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
