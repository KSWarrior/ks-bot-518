name: Minecraft Java Bot No 1 by ks_warrior

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: ks-mc-bot
  cancel-in-progress: true

jobs:
  run-mc-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 85

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Create Optimistic Bot File
        shell: bash
        run: |
          cat > ks-bot.js <<'EOF'
          const mineflayer = require('mineflayer');

          // Server settings
          const options = {
            host: 'ks_warrior_bot.aternos.me', // Replace with your server IP
            port: 34150,                        // Replace with your server port
            username: 'OptimistBot',            // Bot name
          };

          // Function to create bot
          function createBot() {
            const bot = mineflayer.createBot(options);

            bot.on('login', () => {
              console.log('üòÉ Joined the server with optimism!');
              bot.chat('Hello everyone! Ready to have fun! üéâ');

              // Make bot occasionally jump happily
              setInterval(() => {
                if (bot.entity) bot.setControlState('jump', true);
                setTimeout(() => bot.setControlState('jump', false), 500);
              }, 10000); // Every 10 seconds
            });

            // Reconnect on end
            bot.on('end', () => {
              console.log('üí° Disconnected. Optimistically trying to reconnect...');
              setTimeout(createBot, 5000); // Reconnect after 5 seconds
            });

            // Log errors
            bot.on('error', (err) => {
              console.log('‚ö†Ô∏è Error:', err.message);
            });
          }

          // Start the bot
          createBot();
          EOF

      - name: Install dependencies
        shell: bash
        run: |
          npm init -y
          npm install mineflayer
          npm install -g pm2
          
      - name: Start Minecraft Bot
        shell: bash
        run: |
          pm2 start ks-bot.js --name ks-bot

      - name: Display Bot Logs (500s)
        shell: bash
        run: |
          timeout 500s pm2 logs ks-bot --out
          
      - name: Restart Workflow (every 5h)
        uses: benc-uk/workflow-dispatch@v1
        if: ${{ always() }}
        with:
          workflow: Minecraft Java Bot No 1 by ks_warrior
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
